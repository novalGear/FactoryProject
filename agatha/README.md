# ESP32 HX711 Telegram Bot

Проект для ESP32, который считывает данные с тензодатчика через модуль HX711 и управляется через Telegram‑бота.
Бот позволяет удалённо запрашивать вес, выполнять тарирование и калибровку датчика [web:1].

Поддерживаемые команды бота:

- `/get_weight` — получить текущий вес с датчика (в граммах)
- `/tare` — обнулить показания (установить тару)
- `/calibration N` — калибровка датчика с известным грузом N грамм (после команды `/tare` и помещения груза на датчик)

## Возможности проекта

- Подключение ESP32 к заданной Wi‑Fi сети (2.4 GHz). [web:1]
- Работа с тензодатчиком через модуль HX711 и отдельный модуль `WeightSensor`.
- Управление датчиком веса через Telegram‑бота:
  - чтение текущего веса,
  - установка тары (`/tare`),
  - калибровка по известному весу (`/calibration N`).
- Разделение логики по файлам: модуль датчика, модуль бота, конфигурация и основной файл.

## Структура проекта

- `WeightSensor.h` / `WeightSensor.cpp`
  Модуль работы с HX711 и датчиком веса (функции `begin`, `getWeight`, `tare`, `calibrate`).

- `TelegramBot.h` / `TelegramBot.cpp`
  Модуль работы с Telegram‑ботом: подключение к сети, опрос новых сообщений, обработка команд `/get_weight`, `/tare`, `/calibration N`.

- `Config.h`
  Конфигурация Wi‑Fi, токен бота, chat ID, пины HX711 и сертификат Telegram.

- `main.ino`
  Основной файл `setup()`/`loop()`, который инициализирует датчик, сеть, Telegram‑бота и обрабатывает цикл опроса сообщений.

---

## Настройка Telegram‑бота

Этот раздел описывает, как создать своего Telegram‑бота и получить все нужные данные для заполнения `Config.h` [web:2].

### 1. Создание бота через BotFather

1. Откройте приложение Telegram (мобильное или десктопное). [web:2]
2. В поиске найдите пользователя `@BotFather` (официальный бот Telegram для управления ботами). [web:2]
3. Нажмите **Start** или отправьте команду `/start`. [web:2]
4. Отправьте команду `/newbot`. [web:2]
5. BotFather попросит:
   - ввести **имя бота** (например: `ESP32 Weight Bot`),
   - затем ввести **username** бота, который должен оканчиваться на `bot` (например: `esp32_weight_bot`). [web:2]
6. В ответ BotFather отправит сообщение с данными нового бота, в том числе **HTTP API token** — строку вида:
   `123456789:AAABBBCCCDDDEEE...` — это ваш `BOT_TOKEN` для `Config.h` [web:2].

Сохраните этот токен, он нужен для подключения ESP32 к Telegram Bot API.

### 2. Получение вашего chat ID

Чтобы бот отвечал только вам (или конкретному чату), нужен `CHAT_ID` [web:2].

**Вариант через @userinfobot**

1. В Telegram найдите бота `@userinfobot` (или аналогичный сервис типа `@RawDataBot`). [web:2]
2. Нажмите **Start**.
3. Бот отправит сообщение с информацией о вас, где будет поле `Id:` — это ваш числовой chat ID. [web:2]
4. Скопируйте это значение и используйте в `Config.h` как строку:

   ```cpp
   #define CHAT_ID "123456789"
    ```

## Сертификат Telegram (HTTPS)

Для безопасного подключения к Telegram Bot API ESP32 использует HTTPS и проверку корневого сертификата сервера `api.telegram.org`.

**Как получить актуальный сертификат:**

1. В Arduino IDE откройте **Sketch → Include Library → Manage Libraries**.
2. Найдите и установите библиотеку `UniversalTelegramBot` (автор Brian Lough).
3. В папке **File → Examples → UniversalTelegramBot** найдите пример `Esp8266` или `ArduinoESP32` (в зависимости от архитектуры).
4. В примере будет файл `TelegramCertificate.h` или константа `TELEGRAM_CERTIFICATE` — скопируйте её содержимое.

**Пример структуры в Config.h:**

```cpp
const char* TELEGRAM_CERTIFICATE = \
"-----BEGIN CERTIFICATE-----\n" \
"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw\n" \
" [...] полный сертификат из примера библиотеки [...] \n" \
"-----END CERTIFICATE-----\n";

```

## Настройка ESP32 в Arduino IDE

Для работы с ESP32 в Arduino IDE нужно один раз установить поддержку плат ESP32.

**Пошаговая инструкция:**

1. Откройте Arduino IDE.
2. Перейдите в **File → Preferences** (Файл → Настройки).
3. В поле **Additional Board Manager URLs** добавьте следующий URL (скопируйте и вставьте):

https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json


4. Нажмите **OK**.
5. Перейдите в **Tools → Board → Boards Manager** (Инструменты → Плата → Менеджер плат).
6. В поле поиска введите `esp32`, найдите пакет **esp32 by Espressif Systems** и нажмите **Install**.
7. После установки в **Tools → Board** выберите вашу плату ESP32 (например, **ESP32 Dev Module**).
8. Подключите ESP32 к компьютеру USB-кабелем, выберите правильный **Port** в **Tools → Port**.
9. Загрузите скетч кнопкой **Upload** (стрелка вправо).

**Официальная документация:**
https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html

## Калибровка датчика веса через Telegram‑бот

**Пошаговая процедура калибровки:**

1. **Подключите датчик:** Убедитесь, что HX711 подключен к ESP32 по пинам из `Config.h`, а тензодатчик — к HX711.
2. **Обнуление (тара):** Отправьте боту команду `/tare` (на датчике не должно быть груза).
3. **Установите груз:** Положите на платформу датчика **известный вес** (например, 100 г, 200 г).
4. **Калибровка:** Отправьте команду `/calibration 100` (где 100 — точный вес вашего груза в граммах).
5. **Проверка:** Отправьте `/get_weight` — показания должны быть близки к реальному весу (± погрешность датчика).

**Пример последовательности команд:**

\tare

[положили груз в 100 г]

\calibration 100
\get_weight

## Использование бота

**После успешной прошивки ESP32:**

1. **Проверьте Serial Monitor** (Tools → Serial Monitor, 115200 baud):
   - ESP32 должен подключиться к Wi‑Fi и вывести IP‑адрес.
   - Не должно быть ошибок SSL или подключения к Telegram.

2. **Протестируйте бота:**
   - Откройте чат с вашим ботом в Telegram (найдите по username).
   - Отправьте `/help` — бот ответит списком команд.

**Доступные команды:**

| Команда | Описание |
|---------|----------|
| `/get_weight` | Текущий вес с датчика (г) |
| `/tare` | Обнулить показания (тара) |
| `/calibration N` | Калибровка по грузу N грамм |
| `/help` | Справка по командам |

